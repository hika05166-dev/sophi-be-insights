import { getDb } from './index'
import { initSchema, isSeeded } from './schema'

const AGE_GROUPS = ['10代', '20代', '30代', '40代〜'] as const
const MODES = ['生理管理', '妊活'] as const
const CYCLE_PHASES = ['月経期', '卵胞期', '排卵期', '黄体期'] as const

// 会話テンプレート：各ユーザーの悩みに応じたリアルな日本語発話
const conversationTemplates = [
  // 生理痛・PMS関連
  {
    topic: 'menstrual_pain',
    sessions: [
      [
        { role: 'user', content: '最近生理痛がひどくて、鎮痛剤が手放せないんですけど、これって普通ですか？毎月ロキソニンを3〜4錠飲んでしまっています。' },
        { role: 'assistant', content: '生理痛でつらい思いをされているんですね。ロキソニンを毎月3〜4錠お使いとのこと、痛みがかなり強いようですね。生理痛の強さは人それぞれですが、日常生活に支障が出るほどの痛みは「月経困難症」の可能性があります。婦人科を受診されることをおすすめします。何か最近、生活習慣や体調に変化はありましたか？' },
        { role: 'user', content: 'そういえば最近仕事がすごく忙しくて、睡眠時間が5時間くらいになっています。ストレスが原因ってこともあるんでしょうか？' },
        { role: 'assistant', content: 'ストレスや睡眠不足は、生理痛を悪化させる大きな要因になります。睡眠が不足すると自律神経のバランスが崩れ、子宮の収縮を促すプロスタグランジンが過剰に分泌されやすくなります。お仕事が落ち着いたら、睡眠を7〜8時間確保することを意識してみてください。また、温かいシャワーや下腹部のマッサージも一時的な緩和に役立ちます。' },
        { role: 'user', content: 'わかりました。とりあえず今月は湯船につかることを意識してみます。あと、低用量ピルを飲むと生理痛が楽になると聞いたのですが、どうですか？' },
        { role: 'assistant', content: '低用量ピルは生理痛の改善に非常に効果的です。プロスタグランジンの分泌を抑え、子宮内膜を薄くすることで生理量と痛みを減らす効果があります。ただし、処方は婦人科での診察が必要です。副作用の確認や、ご自身の体質に合ったものを選ぶためにも、まず婦人科に相談されることをおすすめします。' },
      ],
      [
        { role: 'user', content: 'PMS（月経前症候群）がひどくて、生理前の1週間はイライラが止まらなくて職場の人間関係がギクシャクしてしまっています…' },
        { role: 'assistant', content: 'PMSによる気分の変化は本当につらいですね。月経前に感情が不安定になるのは、プロゲステロン（黄体ホルモン）の変動が原因です。職場での人間関係への影響も出ているとのこと、ご本人もかなりお困りのことと思います。PMSの緩和には、カルシウム・マグネシウムの摂取、規則的な有酸素運動、カフェインやアルコールの制限が効果的とされています。' },
        { role: 'user', content: 'サプリとか飲んだほうがいいですか？何がおすすめですか？' },
        { role: 'assistant', content: 'PMS対策として研究で効果が示されているサプリメントには、チェストツリー（セイヨウニンジンボク）、マグネシウム、ビタミンB6などがあります。ただし、効果には個人差があります。まずは生活習慣の改善を試みて、それでも改善しない場合は婦人科での相談も選択肢です。低用量ピルやSSRIなど医療的な選択肢もあります。' },
      ],
    ],
  },
  // 妊活関連
  {
    topic: 'fertility',
    sessions: [
      [
        { role: 'user', content: '妊活を始めて半年になります。排卵日の予測がうまくできなくて悩んでいます。基礎体温をつけているのですが、体温のグラフがガタガタでよくわからないんです。' },
        { role: 'assistant', content: '妊活半年間、頑張られているんですね。基礎体温の測定を継続されているのは素晴らしいです。体温グラフがガタガタになる原因として、測定時間のばらつき、睡眠不足、アルコール摂取、体調不良などが考えられます。毎朝同じ時間に、目覚めてすぐ体を起こす前に測定することが重要です。また、2〜3ヶ月分のデータを見てトレンドを掴むことが大切ですよ。' },
        { role: 'user', content: '測定時間はバラバラかもしれません。休日は1〜2時間遅くなってしまっています。それが原因でしょうか？' },
        { role: 'assistant', content: '休日の測定時間のばらつきは、基礎体温に大きく影響します。体温は就寝中に下がり続けるため、起床時間が遅いと体温が上がった後に測ることになってしまいます。できれば休日も平日と同じ時間に測定するのが理想ですが、難しい場合は「いつもより●時間遅い」とメモを残しておくと、データの解釈がしやすくなります。' },
        { role: 'user', content: 'なるほど！試してみます。あと排卵検査薬はどのタイミングで使えばいいですか？基礎体温と組み合わせて使うのがいいと聞きました。' },
        { role: 'assistant', content: '基礎体温と排卵検査薬の組み合わせは、排卵日を特定するのにとても有効です。生理周期が28日の場合、周期12日目頃から排卵検査薬を使い始めるのがおすすめです。LH（黄体形成ホルモン）が急上昇（LHサージ）した後、36〜48時間で排卵するため、陽性が出たらその日と翌日がタイミングを取るベストなタイミングです。基礎体温は排卵後に上昇するので、事後確認に活用できます。' },
      ],
      [
        { role: 'user', content: '不妊治療を検討しているのですが、クリニックに行くのに勇気がいります。何を準備していけばいいですか？' },
        { role: 'assistant', content: '不妊治療クリニックへの第一歩、勇気が必要ですよね。まず、準備していくと良いものをご案内します。①基礎体温表（3ヶ月分あると理想的）、②生理周期のメモ（最近の開始日・日数など）、③これまでの婦人科受診歴・既往歴、④保険証。パートナーの方も一緒に初診を受けることで、より詳しい検査ができます。初診では主に問診と、月経周期に合わせた検査スケジュールの相談になることが多いです。' },
        { role: 'user', content: 'パートナーも一緒に行くべきですか？少し言い出しにくくて…' },
        { role: 'assistant', content: '不妊の原因は男性側にある場合も約半数あるため、カップルで検査を受けることが大切です。「一緒に体のことを知ろう」「二人の問題として取り組みたい」という言葉で伝えると、パートナーも受け入れやすいかもしれません。最初は二人で行くのが難しければ、まず女性だけで相談しても問題ありません。多くのクリニックでは女性単独の受診も対応しています。' },
      ],
    ],
  },
  // 睡眠・ストレス関連
  {
    topic: 'sleep_stress',
    sessions: [
      [
        { role: 'user', content: '生理前になると眠れなくて困っています。なんとなく体がほてって、寝つきが悪くなります。生理周期と関係ありますか？' },
        { role: 'assistant', content: '生理前の不眠、つらいですね。これはホルモンの影響で起こりやすい症状です。排卵後から生理前の黄体期はプロゲステロンが増加し、体温が上昇します。この「高温期」の体のほてりが睡眠を妨げることがあります。寝室を少し涼しめに設定する、就寝1〜2時間前の入浴をシャワーに変える、などを試してみてください。' },
        { role: 'user', content: '確かに黄体期だとわかっていても、毎月この時期が憂鬱です。眠れないとさらにイライラして、悪循環になっています。' },
        { role: 'assistant', content: '睡眠不足→イライラ→さらに眠れないという悪循環、本当につらいですね。いくつか対策をご提案します。①就寝1時間前はスマートフォンを見ない（ブルーライトがメラトニン分泌を妨げます）、②寝床でリラクゼーション音楽や深呼吸を試す、③日中に軽い有酸素運動をする、④カモミールティーなどのハーブティーを就寝前に飲む。それでも改善しない場合は、婦人科での相談もご検討ください。' },
      ],
      [
        { role: 'user', content: '仕事のストレスで生理不順になってしまいました。先月は40日以上来なくて、今月も遅れています。妊娠検査薬は陰性でした。' },
        { role: 'assistant', content: '生理が40日以上来ないのは心配ですね。妊娠検査薬が陰性とのことで、ストレスによる「視床下部性無月経」の可能性があります。強いストレスや急激な体重変化は、ホルモンの分泌をコントロールする視床下部の機能を乱します。まず婦人科を受診して、ホルモン検査などを受けることをおすすめします。現在の仕事量の見直しや、リラクゼーションの時間を意識的に作ることも大切です。' },
        { role: 'user', content: 'ストレスが原因なのはわかっているんですが、仕事は減らせない状況で…。何かできることはありますか？' },
        { role: 'assistant', content: '仕事を減らせない状況、とても大変ですね。できることから少しずつ取り組んでみましょう。①睡眠を優先する（最低6時間確保）、②食事は三食バランスよく、特に大豆イソフラボンや亜鉛を意識する、③5分でも「何もしない時間」を作る、④通勤時間に音楽や瞑想アプリを使う。また、婦人科でホルモン療法の選択肢を相談するのも一つの手です。ご自身の体を一番に考えてあげてくださいね。' },
      ],
    ],
  },
  // 経血量・周期の変化
  {
    topic: 'flow_cycle',
    sessions: [
      [
        { role: 'user', content: '最近経血量が急に増えた気がします。ナプキンを2〜3時間で交換しないといけなくなって、仕事中も不安で集中できません。' },
        { role: 'assistant', content: '経血量が急増して、日常生活に支障が出ているんですね。2〜3時間でナプキンが一杯になるほどの出血は「過多月経」の可能性があります。これは子宮筋腫、子宮内膜症、子宮腺筋症などが原因のことがあります。なるべく早めに婦人科を受診されることをおすすめします。受診の際は「いつから増えたか」「どのくらいの頻度で交換が必要か」を伝えると診察がスムーズです。' },
        { role: 'user', content: '子宮筋腫ってよく聞きますが、どういうものですか？治療が必要になりますか？' },
        { role: 'assistant', content: '子宮筋腫は子宮の筋肉にできる良性の腫瘍です。30〜40代の女性に多く、統計では女性の20〜30%にあるとされています。すべての筋腫が治療を必要とするわけではなく、大きさや位置、症状の程度によって、経過観察・薬物療法・手術など様々な選択肢があります。まずは超音波検査で確認することが大切です。怖い病気ではありませんが、早期発見が大切ですので、受診されてみてください。' },
        { role: 'user', content: 'わかりました。今度の週末に婦人科に行ってみます。貧血も気になっていて、最近めまいや立ちくらみが多いんです。' },
        { role: 'assistant', content: '経血量が多いと鉄欠乏性貧血になりやすく、めまいや立ちくらみの原因になります。受診の際に貧血の血液検査もお願いするといいですね。日常的には、鉄分を多く含む食品（赤身肉、レバー、ほうれん草、ひじき）と、鉄の吸収を助けるビタミンC（柑橘類、パプリカ）を意識して摂ることをおすすめします。市販の鉄剤サプリも補助的に使えますが、医師の指示のもとで使うのがより安心です。' },
      ],
    ],
  },
  // セルフケア・市販薬
  {
    topic: 'self_care',
    sessions: [
      [
        { role: 'user', content: '生理痛に市販薬を使っているのですが、イブプロフェンとロキソニンどっちがいいですか？また、飲むタイミングはいつがベストですか？' },
        { role: 'assistant', content: 'どちらも非ステロイド性抗炎症薬（NSAIDs）で、プロスタグランジンの生成を抑えて痛みを和らげます。効果に大きな差はありませんが、ロキソニンは少し効果が強めと感じる方が多いようです。飲むタイミングは「痛みが出てから」より「痛みが出る前、または出始めに」飲む方が効果的です。生理が始まったら、痛みを感じる前に飲み始めることで、プロスタグランジンの分泌を早めに抑えられます。' },
        { role: 'user', content: '先手必勝で飲むんですね！あと、よく「ピルを飲むと生理痛が楽になる」と聞きますが、市販薬との違いは何ですか？' },
        { role: 'assistant', content: '市販鎮痛薬は「すでに起きた痛みを抑える」のに対し、低用量ピルは「痛みの原因であるプロスタグランジンの産生量自体を減らす」根本的なアプローチです。ピルは子宮内膜を薄く保つため、剥がれる内膜が少なくなり、経血量と生理痛を大幅に軽減できます。継続的に使うことで、毎月の生活の質が改善されます。ただし処方が必要なので、婦人科やオンライン診療での相談が必要です。' },
      ],
      [
        { role: 'user', content: '生理前に肌荒れがひどくなります。ニキビが増えて、肌がカサカサになります。生理と関係していますか？' },
        { role: 'assistant', content: 'はい、生理前の肌荒れはとても一般的です。排卵後から生理前にかけてプロゲステロンが増加すると、皮脂分泌が増えてニキビができやすくなります。また、この時期は肌の水分保持機能も低下しやすいため、乾燥も起きやすくなります。スキンケアは保湿をしっかりと、洗顔は朝晩2回まで、刺激の少ないクレンザーを使うことがポイントです。' },
        { role: 'user', content: '私はいつもこの時期に鼻や顎にニキビができます。チョコレートや脂っこいものを食べると悪化する気がするんですが、食事は関係しますか？' },
        { role: 'assistant', content: '食事と肌荒れの関係は研究が続いており、明確なエビデンスはまだ限られていますが、高GI食品（砂糖・白米・小麦粉を多く含む食品）や乳製品がニキビを悪化させる可能性があるという研究もあります。チョコレートについても直接的な原因というより、砂糖や脂質の影響の可能性があります。生理前1週間は砂糖やスナック菓子を控えめにして、野菜・タンパク質中心の食事を意識してみてください。' },
      ],
    ],
  },
  // 運動・サプリ関連
  {
    topic: 'exercise_supplement',
    sessions: [
      [
        { role: 'user', content: '生理痛を和らげるのに運動は効果ありますか？生理中はどんな運動をすればいいですか？' },
        { role: 'assistant', content: '適度な運動は生理痛の緩和に効果的です。運動によってエンドルフィン（幸福ホルモン）が分泌され、痛みを和らげる効果があります。生理中でも無理のない範囲で体を動かすことをおすすめします。特に効果的なのは、ウォーキング、軽いヨガ（特に腰を温める・ほぐすポーズ）、ゆったりとしたストレッチです。逆に激しい運動は血流を増加させて経血量が増えることがあるため、生理中は控えめにしましょう。' },
        { role: 'user', content: 'ヨガは前からやってみたいと思っていました。月経期に特におすすめのポーズってありますか？' },
        { role: 'assistant', content: '月経期に特におすすめのヨガポーズをご紹介します。①チャイルドポーズ（子どもの姿勢）：うつ伏せで正座し、腕を前に伸ばして休む。腰から下腹部をリラックスさせます。②スパインツイスト（ねじりのポーズ）：腰をほぐして血行を促します。③バタフライポーズ：足の裏を合わせて座り、股関節を開く。骨盤周りの緊張を緩和します。生理中は「陰ヨガ」や「リストラティブヨガ」のような穏やかなスタイルがおすすめです。' },
      ],
      [
        { role: 'user', content: '妊活中で葉酸サプリを飲もうと思っているのですが、どれを選べばいいかわかりません。成分とか量とか気にすべき点はありますか？' },
        { role: 'assistant', content: '葉酸は妊活・妊娠初期に特に重要な栄養素ですね。選ぶ際のポイントをお伝えします。①葉酸量：厚生労働省は妊娠を希望する女性に1日400μgの葉酸摂取を推奨しています。②形態：「モノグルタミン酸型（合成葉酸）」の方が食品中の葉酸より吸収率が高いです。③追加成分：鉄・カルシウム・ビタミンD・DHA含有のものは妊活〜妊娠中に役立ちます。④飲み始め時期：妊娠の1ヶ月前から飲み始めることが推奨されています。' },
        { role: 'user', content: 'ありがとうございます。あと鉄分も不足しがちと聞きます。どんな食事を心がければいいですか？' },
        { role: 'assistant', content: '妊活中は特に鉄分を意識した食事が大切です。鉄分には「ヘム鉄（動物性）」と「非ヘム鉄（植物性）」があり、ヘム鉄の方が吸収率が高いです。ヘム鉄が豊富な食品：赤身牛肉、豚レバー、鶏レバー、かつおやまぐろ。非ヘム鉄が豊富な食品：小松菜、ほうれん草、ひじき、納豆。非ヘム鉄はビタミンCと一緒に摂ると吸収率が上がります。食後に柑橘類のフルーツを食べるのもおすすめです。鉄分サプリを使う場合は空腹時を避け、ビタミンCと一緒に摂るといいですよ。' },
      ],
    ],
  },
  // 生理不順・不安
  {
    topic: 'irregular_anxiety',
    sessions: [
      [
        { role: 'user', content: '生理が来るたびに周期が変わります。25日の時もあれば35日の時もあって、予定が立てられなくて困っています。これは異常ですか？' },
        { role: 'assistant', content: '生理周期は25〜38日が正常範囲とされており、この範囲内での変動は多くの方に見られます。ただし、同じ方の周期が毎月7日以上ずれる場合は「不規則月経」と考えられます。ストレス、睡眠不足、体重の急激な変化、激しい運動などが原因になることが多いです。基礎体温をつけると、自分の周期のパターンがより把握しやすくなります。3ヶ月以上記録してみてはいかがでしょうか？' },
        { role: 'user', content: '基礎体温はつけたことがないです。スマートフォンのアプリでできますか？コツを教えてください。' },
        { role: 'assistant', content: 'スマートフォンアプリで基礎体温を管理する方は増えています。よく使われているアプリには「ルナルナ」「生理日管理アプリ」などがあります。コツをお伝えします。①起床直後、体を起こす前に舌の下に体温計を入れて測る（最低5分）。②毎朝同じ時間に測る（±30分以内が理想）。③測ったらすぐアプリに記録。④アルコールを飲んだ日、睡眠不足の日、体調不良の日はメモを残す。最初の1ヶ月はグラフが見づらくても、2〜3ヶ月続けると自分のパターンが見えてきます。' },
      ],
      [
        { role: 'user', content: '38歳です。最近生理の量が減って、周期も短くなってきました。更年期の始まりかと不安です。' },
        { role: 'assistant', content: '38歳でそのような変化が気になるお気持ち、よくわかります。更年期は一般的に45〜55歳頃に起こりますが、40代前半から「プレ更年期」と呼ばれる時期が始まる方もいます。経血量の減少や周期の変化は、卵巣機能の変化のサインのこともあります。確認のためにも、一度婦人科でホルモン検査（FSH、LH、エストロゲン）を受けてみることをおすすめします。早めに状況を把握することで、必要であれば適切なケアができます。' },
        { role: 'user', content: 'ホルモン検査は生理の何日目に受けるのがいいですか？また費用はどのくらいかかりますか？' },
        { role: 'assistant', content: 'ホルモン検査の受け方についてお答えします。タイミング：FSH・LH・エストロゲンの検査は、月経2〜5日目（月経期）に受けるのが一般的です。プロゲステロンは黄体期（生理前1週間頃）に検査します。費用：保険が適用される場合、検査費用は3割負担で数千円程度が多いです。自費の場合は5,000〜1万円程度です。初診料・再診料が別途かかります。まず「月経不順・ホルモン検査希望」と伝えて予約すると、適切なタイミングを案内してもらえます。' },
      ],
    ],
  },
  // 妊活詳細
  {
    topic: 'fertility_advanced',
    sessions: [
      [
        { role: 'user', content: '体外受精を考えています。費用が気になるのですが、保険は使えますか？どのくらいかかりますか？' },
        { role: 'assistant', content: '2022年4月から、体外受精（IVF）は保険適用になりました。適用条件：①女性が43歳未満、②一定の回数制限あり（43歳未満は通算6回まで、40歳以上43歳未満は3回まで）。費用の目安（3割負担）：採卵〜移植1サイクルで30〜50万円程度（クリニックや治療内容により異なります）。保険適用前は100万円以上かかることもあったため、大幅な負担軽減になっています。詳細は受診するクリニックで確認されることをおすすめします。' },
        { role: 'user', content: '保険が使えるようになったんですね！知らなかったです。まずどのクリニックに行けばいいかわからなくて。' },
        { role: 'assistant', content: '不妊治療専門クリニックの選び方のポイントをお伝えします。①日本産科婦人科学会の認定施設であること、②通いやすい立地（治療中は頻繁な通院が必要です）、③採卵数や妊娠率などの実績を公開していること、④カウンセリング体制が充実していること。日本生殖医学会のウェブサイトで施設検索もできます。まずはかかりつけの婦人科に相談して紹介してもらうか、口コミサイトで地域の施設を探すのがおすすめです。' },
      ],
    ],
  },
]

// 追加の単発セッション（バリエーション増やし用）
const additionalSessions: { role: string; content: string }[][] = [
  [
    { role: 'user', content: '生理痛がひどい日は会社を休んでいいと思いますか？上司に言いにくくて。' },
    { role: 'assistant', content: '生理痛による欠勤は正当な理由です。労働基準法には「生理休暇」の規定もあります（使用しない企業が多いですが）。つらい時は「体調不良」として休むのも選択肢の一つです。長期的には、婦人科での治療によって生理痛を軽減できると、仕事への影響も減らせます。職場での生理についての理解はまだ課題がありますが、ご自身の体を守ることを最優先に考えてください。' },
    { role: 'user', content: '生理休暇があるんですね。知りませんでした。ありがとうございます。' },
    { role: 'assistant', content: '生理休暇は労基法第68条で定められていますが、有給か無給かは会社によって異なります。まずは就業規則を確認してみてください。体調管理と仕事のバランスを取りながら、無理せず過ごしてくださいね。他に気になることがあればまたいつでも聞いてください。' },
  ],
  [
    { role: 'user', content: 'チョコレートや甘いものが生理前に無性に食べたくなります。これは体のサインですか？' },
    { role: 'assistant', content: '生理前に甘いものが食べたくなるのはとても一般的です。これはいくつかの生理的な理由があります。①プロゲステロンの増加が血糖値を下げやすくし、糖分を欲しがらせる、②セロトニン（幸福感をもたらす神経伝達物質）が低下し、甘いものでセロトニンを補おうとする、③マグネシウム不足—チョコレートにはマグネシウムが含まれており、体が直感的に求めている可能性もあります。' },
    { role: 'user', content: 'では食べてもいいんですか？我慢した方がいい？' },
    { role: 'assistant', content: '完全に我慢する必要はありませんが、量と質を意識すると良いですね。おすすめは、カカオ含有量70%以上のダークチョコレートを少量。砂糖が少なく、マグネシウムも多く含まれています。また、甘いものへの欲求は食事のタイミングや量でも変わります。3食きちんと食べ、血糖値の急激な変動を防ぐことで、甘いものへの欲求が安定することがあります。' },
  ],
  [
    { role: 'user', content: '排卵痛があります。毎月排卵期に下腹部が痛くなるのですが、これは正常ですか？' },
    { role: 'assistant', content: '排卵痛（中間痛）は多くの女性が経験する正常な現象です。排卵時に卵胞が破れ、卵子が放出される際の刺激が痛みとして感じられます。通常は数分〜数時間で自然におさまります。ただし、痛みが強い、長時間続く、発熱や出血を伴うなどの場合は婦人科受診をおすすめします。排卵痛があると排卵日の見当をつけやすいというメリットもあります。' },
    { role: 'user', content: '排卵痛を排卵日の目安にしてもいいんですね。妊活中なので参考にします。' },
    { role: 'assistant', content: '排卵痛は排卵のサインの一つとして活用できますが、痛みの後に実際に排卵するかどうかには個人差があります。排卵検査薬や基礎体温と組み合わせて使うと、より精度が上がります。排卵後12〜24時間以内が妊娠しやすいタイミングなので、排卵痛を感じたらその日と翌日がベストタイミングになります。妊活を頑張ってください！' },
  ],
  [
    { role: 'user', content: '漢方薬が生理不順や生理痛に効くと聞いたのですが、どんなものがありますか？' },
    { role: 'assistant', content: '漢方薬は生理不順や生理痛に古くから使われており、体質改善を通じて症状を和らげるアプローチです。代表的なものをご紹介します。①当帰芍薬散（とうきしゃくやくさん）：冷え性・むくみ・生理不順に。②桂枝茯苓丸（けいしぶくりょうがん）：血行を改善し、生理痛・PMS・子宮筋腫に。③加味逍遙散（かみしょうようさん）：イライラ・不眠・PMSに。漢方は体質によって合う合わないがあるため、漢方専門医または漢方に詳しい婦人科医への相談をおすすめします。' },
    { role: 'user', content: '市販の漢方薬は試してみてもいいですか？病院に行かなくても自分で選べますか？' },
    { role: 'assistant', content: '市販の漢方薬（OTC漢方）も販売されていますが、効果を発揮するには体質に合ったものを選ぶことが大切です。薬局の漢方コーナーには専門の薬剤師（漢方相談が受けられる薬局もあります）がいることがあります。「生理不順」「生理痛」などの症状と体質（冷え性か熱感があるか、むくみがちか、など）を伝えると適切なものを選んでもらえます。ただし、1ヶ月試して効果が感じられない場合は、婦人科や漢方外来での診察をおすすめします。' },
  ],
  [
    { role: 'user', content: '生理中に激しい頭痛があります。市販の頭痛薬を飲んでいますが、生理との関連はありますか？' },
    { role: 'assistant', content: '生理に伴う頭痛は「月経関連片頭痛」として知られており、生理前後にエストロゲンが急激に低下することが主な原因です。女性の片頭痛の多くは生理と関連しているとされています。市販の鎮痛薬（イブプロフェン、ロキソニン）は有効ですが、使用が月に10日以上になると「薬物乱用頭痛」のリスクがあるため注意が必要です。片頭痛が月に3回以上ある場合は、神経内科や頭痛外来への受診をおすすめします。' },
    { role: 'user', content: '確かに月に何度も頭痛薬を飲んでいます。依存になるんですね、知りませんでした。' },
    { role: 'assistant', content: '「薬物乱用頭痛」は、鎮痛薬の過剰使用によって逆に頭痛が慢性化してしまう状態です。月に10〜15日以上鎮痛薬を服用している場合はリスクがあります。頭痛外来では、トリプタン系薬（片頭痛専用薬）の処方や、予防薬の使用など、より根本的な治療が受けられます。また、生理前のエストロゲン補充（ピルのパッチなど）で月経関連片頭痛を予防できることもあります。一度専門医に相談されることをおすすめします。' },
  ],
]

function randomFrom<T>(arr: readonly T[]): T {
  return arr[Math.floor(Math.random() * arr.length)]
}

function randomInt(min: number, max: number): number {
  return Math.floor(Math.random() * (max - min + 1)) + min
}

function formatDate(date: Date): string {
  return date.toISOString().replace('T', ' ').substring(0, 19)
}

function subtractDays(date: Date, days: number): Date {
  const d = new Date(date)
  d.setDate(d.getDate() - days)
  return d
}

export function seedDatabase(): void {
  initSchema()
  if (isSeeded()) return

  const db = getDb()
  const now = new Date()

  // --- Users ---
  const insertUser = db.prepare(
    'INSERT INTO users (anonymous_id, age_group, mode, cycle_phase, created_at) VALUES (?, ?, ?, ?, ?)'
  )
  const userIds: number[] = []

  for (let i = 1; i <= 50; i++) {
    const anonymous_id = `user_${String(i).padStart(3, '0')}`
    const age_group = randomFrom(AGE_GROUPS)
    // 妊活モードは20代〜40代に多め
    const mode = age_group === '10代' ? '生理管理' : (Math.random() < 0.3 ? '妊活' : '生理管理')
    const cycle_phase = randomFrom(CYCLE_PHASES)
    const created_at = formatDate(subtractDays(now, randomInt(30, 365)))

    const result = insertUser.run(anonymous_id, age_group, mode, cycle_phase, created_at)
    userIds.push(result.lastInsertRowid as number)
  }

  // --- Utterances ---
  const insertUtterance = db.prepare(
    'INSERT INTO utterances (user_id, session_id, role, content, created_at) VALUES (?, ?, ?, ?, ?)'
  )

  const allTemplates = [
    ...conversationTemplates.flatMap(t => t.sessions),
    ...additionalSessions,
  ]

  let sessionCounter = 1

  for (const userId of userIds) {
    const numSessions = randomInt(2, 5)
    for (let s = 0; s < numSessions; s++) {
      const session_id = `session_${String(sessionCounter).padStart(4, '0')}`
      sessionCounter++

      const template = randomFrom(allTemplates)
      const sessionDate = subtractDays(now, randomInt(1, 180))

      template.forEach((msg, idx) => {
        const msgDate = new Date(sessionDate)
        msgDate.setMinutes(msgDate.getMinutes() + idx * randomInt(1, 5))
        insertUtterance.run(userId, session_id, msg.role, msg.content, formatDate(msgDate))
      })
    }
  }

  // --- Search Logs ---
  const searchKeywords = [
    '生理痛', 'PMS', '生理不順', '睡眠不足', 'ストレス', '肌荒れ',
    'ロキソニン', 'イブプロフェン', '低用量ピル', '子宮筋腫', '子宮内膜症',
    '妊活', '排卵日', '基礎体温', '排卵検査薬', '葉酸', '鉄分', '不妊治療',
    '体外受精', '経血量', '月経困難症', '月経前症候群', 'ホルモン',
    'サプリ', 'ヨガ', '漢方', '頭痛', '更年期', 'プレ更年期',
    'セルフケア', '婦人科', '運動', 'カルシウム', 'マグネシウム',
  ]

  const internalUsers = [
    '田中', '佐藤', '鈴木', '高橋', '伊藤',
    '渡辺', '山本', '中村', '小林', '加藤',
  ]

  const insertSearchLog = db.prepare(
    'INSERT INTO search_logs (keyword, searched_by, searched_at) VALUES (?, ?, ?)'
  )

  for (let i = 0; i < 100; i++) {
    const keyword = randomFrom(searchKeywords)
    const searched_by = randomFrom(internalUsers)
    const searched_at = formatDate(subtractDays(now, randomInt(0, 30)))
    insertSearchLog.run(keyword, searched_by, searched_at)
  }

  console.log('✅ Seed data inserted successfully')
}
